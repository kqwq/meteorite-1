<!DOCTYPE html>
<html>
  <head>
    <title>Meteor Visualization</title>
    <script src="//unpkg.com/globe.gl"></script>
    <style>
      body {
        margin: 0;
      }
      .tooltip {
        z-index: 100;
        border: 1px solid #333;
        background-color: #f7f5d1;
        color: #333;
        padding: 5px;
        -moz-border-radius: 2px;
        -webkit-border-radius: 2px;
        border-radius: 2px;
      }
    </style>
  </head>
  <body>
    <div id="globe"></div>

    <script>
      function randomHexColor() {
        return "#000000".replace(/0/g, function () {
          return (~~(Math.random() * 16)).toString(16);
        });
      }
      function csvToJSON(csv) {
        const lines = csv.split("\n");
        const headers = lines.shift().split(",");
        return lines.map((line) => {
          const obj = {};
          const currentline = line.split(",");
          headers.forEach((header, i) => {
            obj[header] = currentline[i];
          });
          return obj;
        });
      }

      // Create and configure globe
      const globe = new Globe()
        // .lineHoverPrecision(0.5)

        .globeImageUrl("//unpkg.com/three-globe/example/img/earth-day.jpg")
        .globeImageUrl("//unpkg.com/three-globe/example/img/earth-night.jpg")
        .globeImageUrl(
          "//unpkg.com/three-globe/example/img/earth-blue-marble.jpg"
        )

        //  /earth-day.jpg for a day view
        //  /earth-night.jpg for a night view (HD)
        //  /earth-blue-marble.png for a blue day view (HD)
        .backgroundImageUrl("//unpkg.com/three-globe/example/img/night-sky.png")
        .pointResolution(24)
        .pointColor("color")
        .pointAltitude("altitude")
        .pointRadius("radius")
        // Point tooltip, displaying a customizable label
        .pointLabel("label");
      // Point radius
      // .pointRadius(0.5);
      const globeElement = document.getElementById("globe");
      globe(globeElement);

      // Get NASA meteorite landings data
      fetch("./meteorite-landings.json")
        .then((res) => res.json())
        .then((json) => {
          let data = json.filter((d) => d.reclat && Number(d.reclat));
          data = data.sort((a, b) => b.mass - a.mass).slice(0, 2000);
          const gData = data.map((d) => {
            const dMassCubed = d.mass ** (1 / 3);
            const rad = dMassCubed * 0.02;
            const height = 0.5 / dMassCubed;
            return {
              lat: parseFloat(d.reclat),
              lng: parseFloat(d.reclong),
              radius: rad,
              altitude: height,
              color: randomHexColor(),
              label: `<div class="tooltip">
              <b>${d.name}</b>
              <div>Mass: ${Number(d.mass).toLocaleString()} g</div>
              <div>Year: ${d.year.split("-")[0]}</div>
              <div>Class: ${d.recclass}</div>
              </div>`,
            };
          });
          console.log(data);
          globe.pointsData(gData);
        });
    </script>
  </body>
</html>
